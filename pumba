#!/bin/sh

set -e

# ==============================================================================
# Variables
# ==============================================================================

GIT_BRANCH="${GIT_BRANCH:-master}"
PIP_REQUIREMENTS_FILE="${PIP_REQUIREMENTS_FILE:-requirements.txt}"
PYTHON_MAIN="${PYTHON_MAIN:-main.py}"
PYTHON_VIRTUALENV=".virtualenv"
REPOSITORY_PATH="/usr/src/app"

# ==============================================================================
# Utilities
# ==============================================================================

_assert_is_set() {
    if [ -z "$1" ]; then
        echo "VALUE FOR ENVIRONMENT VARIABLE \"$2\" MISSING" >&2
        exit 1
    fi
}

_display_step() {
    echo "
================================================================================
$(date --rfc-3339 seconds)
$1
================================================================================
"
}

# ==============================================================================
# Script
# ==============================================================================

_assert_is_set "$GIT_BRANCH" GIT_BRANCH
_assert_is_set "$GIT_URL" GIT_URL
_assert_is_set "$PIP_REQUIREMENTS_FILE" PIP_REQUIREMENTS_FILE
_assert_is_set "$PYTHON_MAIN" PYTHON_MAIN
_assert_is_set "$REPOSITORY_PATH" REPOSITORY_PATH

_display_step "Cloning git repository $GIT_URL"

mkdir -p "$REPOSITORY_PATH"
cd "$REPOSITORY_PATH"
[ -d ".git" ] || git clone "$GIT_URL" ./
git submodule update --init --recursive
[ "$GIT_BRANCH" != "$(git rev-parse --abbrev-ref HEAD)" ] && \
    git checkout -b "$GIT_BRANCH" "origin/$GIT_BRANCH"
git pull

_display_step "Setting up virtualenv"

[ -d "$PYTHON_VIRTUALENV" ] || virtualenv "$PYTHON_VIRTUALENV" -p python3
# shellcheck disable=SC1090
. "$PYTHON_VIRTUALENV/bin/activate"

_display_step "Installing dependencies"

pip install -r "$PIP_REQUIREMENTS_FILE"

_display_step "Running $PYTHON_MAIN"

python3 "$PYTHON_MAIN"

_display_step "Exiting"
